<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>灵枢 · Linga Chat</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🔮</text></svg>">
    
    <!-- 代码高亮样式 -->
    <link rel="stylesheet" href="lib/github.min.css">
    
    <!-- KaTeX 数学公式样式 -->
    <link rel="stylesheet" href="lib/katex.min.css">
    
    <!-- 引入外部CSS -->
    <link rel="stylesheet" href="style.css?v=179">
    
    <!-- Markdown解析 -->
    <script src="lib/marked.min.js"></script>
    
    <!-- XSS防护 -->
    <script src="lib/purify.min.js"></script>

    <!-- 代码高亮 -->
    <script src="lib/highlight.min.js"></script>
    
    <!-- KaTeX 数学公式渲染 -->
    <script src="lib/katex.min.js"></script>
</head>
<body>

<div class="app-container" id="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="app-title">🔮 灵枢</div>
            <div class="sidebar-buttons">
                <button id="new-conversation-btn">新对话</button>
            </div>
        </div>
        <div class="current-chat-info" id="current-chat-info">
            <span class="current-chat-title" id="chat-title">请选择对话</span>
        </div>
        <div class="conversation-list" id="conversation-list"></div>
        <div class="sidebar-footer">
            <button class="settings-btn" id="settings-btn">⚙️ 设置</button>
        </div>
    </div>

    <div class="main-panel" id="main-panel">
        <!-- 拖拽上传遮罩 -->
        <div class="drop-overlay" id="drop-overlay">
            <div class="drop-overlay-content">
                <span class="drop-icon">📎</span>
                <span class="drop-text">释放以上传文件</span>
            </div>
        </div>
        
        <div class="chat-messages" id="chat-messages"></div>
        
        <!-- 已上传文件预览区 -->
        <div class="uploaded-files-preview" id="uploaded-files-preview" style="display: none;">
            <div class="uploaded-files-list" id="uploaded-files-list"></div>
        </div>
        
        <div class="chat-footer">
            <div class="chat-toolbar">
                <div class="chat-toggles">
                    <!-- 文件上传按钮 -->
                    <label class="file-upload-label custom-tooltip " data-tooltip="上传文件">
                        <input type="file" id="file-upload-input" multiple accept=".pdf,.docx,.doc,.txt,.md,.csv,.json,.xml,.html,.htm,.png,.jpg,.jpeg,.gif,.bmp,.webp" style="display: none;">
                        <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                        </svg>
                    </label>
                    
                    <label class="custom-tooltip " data-tooltip="知识库检索"><input type="checkbox" id="toggle-knowledge"><span>📚</span></label>
                    
                    <!-- MCP 工具选择 -->
                    <div class="toggle-with-popup" id="mcp-toggle-wrapper">
                        <label class="custom-tooltip " data-tooltip="MCP 工具"><input type="checkbox" id="toggle-mcp"><span>🔧</span></label>
                        <div class="toggle-popup" id="mcp-popup">
                            <div class="toggle-popup-title">选择 MCP 服务</div>
                            <div class="toggle-popup-options" id="mcp-options"></div>
                        </div>
                    </div>
                    
                    <label class="custom-tooltip " data-tooltip="联网搜索"><input type="checkbox" id="toggle-web"><span>🌐</span></label>
                    
                    <!-- 深度思考开关 -->
                    <div id="thinking-toggle-wrapper" style="display: none;">
                        <label class="custom-tooltip " data-tooltip="深度思考"><input type="checkbox" id="toggle-thinking" checked><span>🧠</span></label>
                    </div>
                    
                    <!-- 视觉识别开关（当模型不支持视觉时显示） -->
                    <div class="toggle-with-popup" id="vision-toggle-wrapper" style="display: none;">
                        <label class="custom-tooltip " data-tooltip="图片/文档识别方式"><input type="checkbox" id="toggle-vision-recognition"><span>👁️</span></label>
                        <div class="toggle-popup" id="vision-popup">
                            <div class="toggle-popup-title">图片/文档识别</div>
                            <div class="toggle-popup-options">
                                <label class="vision-option">
                                    <input type="radio" name="vision-mode" value="none" checked>
                                    <span>不启用</span>
                                </label>
                                <label class="vision-option">
                                    <input type="radio" name="vision-mode" value="ocr">
                                    <span>本地 OCR</span>
                                </label>
                                <label class="vision-option">
                                    <input type="radio" name="vision-mode" value="vision">
                                    <span>视觉模型</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 生图模式 -->
                    <div class="toggle-with-popup" id="image-gen-toggle-wrapper" style="display: none;">
                        <label class="custom-tooltip " data-tooltip="生图模式"><input type="checkbox" id="toggle-image-gen"><span>🎨</span></label>
                        <div class="toggle-popup" id="image-gen-popup">
                            <div class="toggle-popup-title">🎨 生图设置</div>
                            <div class="toggle-popup-options">
                                <div class="image-gen-option">
                                    <label>图片尺寸</label>
                                    <div class="image-gen-size-inputs">
                                        <input type="number" id="image-gen-width" value="1024" min="256" max="4096" step="64" placeholder="宽度">
                                        <span>×</span>
                                        <input type="number" id="image-gen-height" value="1024" min="256" max="4096" step="64" placeholder="高度">
                                    </div>
                                </div>
                            </div>
                            <div class="image-gen-tip">
                                💡 开启后输入描述即可生图
                            </div>
                        </div>
                    </div>
                </div>
                <div class="chat-selectors">
                    <div class="model-selector-wrapper">
                        <span class="model-caps-badge" id="model-caps-badge"></span>
                        <div class="custom-select" id="model-select-wrapper">
                            <div class="custom-select-trigger" id="model-select-trigger">
                                <span class="custom-select-value">未配置</span>
                                <span class="custom-select-arrow">▼</span>
                            </div>
                            <div class="custom-select-dropdown" id="model-select-dropdown"></div>
                            <select id="model-select" style="display:none;">
                                <option value="">未配置</option>
                            </select>
                        </div>
                    </div>
                    <select id="provider-select" class="custom-tooltip " data-tooltip="选择Provider">
                        <option value="">未配置</option>
                    </select>
                </div>
            </div>
            <div class="chat-input-container">
                <textarea id="user-input" placeholder="输入消息，Enter 发送"></textarea>
                <button id="send-btn">发送</button>
            </div>
        </div>
    </div>
</div>

<!-- 设置弹窗 -->
<div class="modal settings-modal" id="settings-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">⚙️ 系统设置</span>
            <button class="modal-close" data-target="settings-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div style="width: 100%;">
                <!-- 界面设置 -->
                <div class="settings-section">
                    <h4>🎨 界面设置</h4>
                    <div class="settings-row">
                        <label>界面比例</label>
                        <select id="layout-scale-select">
                            <option value="xs">极小</option>
                            <option value="sm">较小</option>
                            <option value="normal" selected>标准</option>
                            <option value="lg">较大</option>
                            <option value="xl">极大</option>
                        </select>
                    </div>
                </div>

                <!-- AI设置 -->
                <div class="settings-section">
                    <h4>🤖 AI设置</h4>
                    <div class="settings-row">
                        <label>
                            默认对话模型
                            <span class="help-icon custom-tooltip" data-tooltip="新对话时默认使用的模型
选择'记忆上次选择'则自动使用上次选择的模型">?</span>
                        </label>
                        <select id="default-chat-model-select">
                            <option value="remember_last">记忆上次选择</option>
                            <option value="">使用 Provider 默认模型</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <label>
                            自动命名模型
                            <span class="help-icon custom-tooltip" data-tooltip="新对话发送第一条消息后，将使用此模型自动生成对话标题
选择'使用当前对话模型'则使用对话中选择的模型">?</span>
                        </label>
                        <select id="auto-title-model-select">
                            <option value="current">使用当前对话模型</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <label>
                            默认视觉模型
                            <span class="help-icon custom-tooltip" data-tooltip="当对话模型不支持图片识别时，
将使用此模型解析图片内容，再将结果发送给对话模型处理">?</span>
                        </label>
                        <select id="default-vision-model-select">
                            <option value="">不启用</option>
                        </select>
                    </div>
                </div>

                <!-- 联网搜索设置 -->
                <div class="settings-section">
                    <h4>🌐 联网搜索设置</h4>
                    <div class="settings-row">
                        <label>配置搜索API密钥</label>
                        <button type="button" id="manage-search-keys-btn">配置联网搜索</button>
                    </div>
                </div>

                <!-- 管理功能 -->
                <div class="settings-section">
                    <h4>🛠️ 系统管理</h4>
                    <div class="settings-row">
                        <label>模型提供商管理</label>
                        <button type="button" id="manage-providers-btn">管理 Provider</button>
                    </div>
                    <div class="settings-row">
                        <label>知识库管理</label>
                        <button type="button" id="manage-knowledge-btn">管理知识库</button>
                    </div>
                    <div class="settings-row">
                        <label>MCP服务器管理</label>
                        <button type="button" id="manage-mcp-btn">管理 MCP</button>
                    </div>
                    <div class="settings-row">
                        <label>导出调试日志</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="export-logs-hours" style="width: 100px;">
                                <option value="1">1小时</option>
                                <option value="6">6小时</option>
                                <option value="24" selected>24小时</option>
                                <option value="72">3天</option>
                                <option value="168">7天</option>
                            </select>
                            <button type="button" id="export-logs-btn">导出日志</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Provider 管理弹窗 -->
<div class="modal" id="provider-modal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <span class="modal-title">🔧 模型提供商管理</span>
            <button class="modal-close" data-target="provider-modal" data-return="settings-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div class="provider-list-container">
                <h3>已配置的 Provider</h3>
                <div id="provider-list"></div>
            </div>
            <div class="provider-form-container">
                <h3 id="provider-form-title">新建 Provider</h3>
                <form id="provider-form">
                    <input type="hidden" id="provider-id">
                    <div class="form-row">
                        <label>名称 <span class="required">*</span></label>
                        <input type="text" id="provider-name" required placeholder="如 OpenAI / 智谱AI">
                    </div>
                    <div class="form-row">
                        <label>API Base URL <span class="required">*</span></label>
                        <input type="text" id="provider-api-base" required placeholder="https://api.openai.com/v1">
                    </div>
                    <div class="form-row">
                        <label>API Key</label>
                        <input type="password" id="provider-api-key" placeholder="输入 API Key（可选）">
                        <small id="api-key-hint" style="display:none;">留空则保持原密钥不变</small>
                    </div>
                    
                    <!-- 默认模型配置 -->
                    <div class="form-row">
                        <label>默认模型 <span class="required">*</span></label>
                        <div class="model-config-card default-model-card">
                            <div class="model-inputs">
                                <input type="text" id="provider-default-model" required placeholder="输入模型名称，如 gpt-4o">
                                <input type="text" id="provider-default-model-name" placeholder="自定义名称（可选）">
                            </div>
                            <div class="model-capabilities">
                                <label><input type="checkbox" id="default-cap-vision"> 视觉</label>
                                <label><input type="checkbox" id="default-cap-reasoning"> 推理</label>
                                <label><input type="checkbox" id="default-cap-chat" checked> 对话</label>
                                <label><input type="checkbox" id="default-cap-image-gen"> 生图</label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 其他模型列表 -->
                    <div class="form-row">
                        <label>其他模型列表</label>
                        <div id="provider-models-container" class="models-list-container">
                            <!-- 动态添加的模型卡片 -->
                        </div>
                        <button type="button" id="add-model-btn" class="add-model-btn">+ 添加模型</button>
                        <small>点击添加更多模型，可为每个模型标记功能</small>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" id="provider-submit-btn">保存</button>
                        <button type="button" id="provider-form-reset">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 知识库管理弹窗 -->
<div class="modal" id="knowledge-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">📚 知识库管理</span>
            <button class="modal-close" data-target="knowledge-modal" data-return="settings-modal">&times;</button>
        </div>
        <div class="modal-body" style="flex-direction: column; gap: 20px;">
            <!-- 上半部分：知识库列表和上传 -->
            <div style="display: flex; gap: 30px;">
                <div class="kb-list-container">
                    <h3>我的知识库</h3>
                    <div id="kb-list"></div>
                    
                    <h3 style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 12px;">新建知识库</h3>
                    <form id="kb-form">
                        <div class="form-row">
                            <label>名称</label>
                            <input type="text" id="kb-name" placeholder="如 公司文档">
                        </div>
                        <div class="form-row">
                            <label>描述</label>
                            <input type="text" id="kb-description" placeholder="可选描述">
                        </div>
                        <div class="form-actions">
                            <button type="submit">创建</button>
                        </div>
                    </form>
                </div>
                <div class="kb-upload-container">
                    <h3>上传文档</h3>
                    <form id="kb-upload-form">
                        <!-- 已有文件列表 -->
                        <div id="kb-existing-files" class="kb-existing-files" style="display: none;"></div>
                        
                        <!-- 模型配置区域 -->
                        <div class="kb-model-config">
                            <div class="form-row">
                                <label>
                                    向量模型 <span class="required-badge">必选</span>
                                    <span class="help-icon custom-tooltip" data-tooltip="用于将文本转换为向量，实现语义搜索
支持 text-embedding-3-small 等模型">?</span>
                                </label>
                                <select id="embedding-model-select">
                                    <option value="">请选择向量模型</option>
                                </select>
                                <small>用于将文本转换为向量，实现语义搜索</small>
                            </div>
                            
                            <div class="form-row">
                                <label>
                                    重排模型 <span class="optional-badge">可选</span>
                                    <span class="help-icon custom-tooltip" data-tooltip="用于对检索结果重新排序，提高相关性
支持 rerank 类模型">?</span>
                                </label>
                                <select id="rerank-model-select">
                                    <option value="">不使用重排模型</option>
                                </select>
                                <small>对检索结果重新排序，提高相关性</small>
                            </div>
                            
                            <div class="form-row">
                                <label>
                                    图片识别方案 <span class="optional-badge">可选</span>
                                    <span class="help-icon custom-tooltip" data-tooltip="用于识别文档中的图片内容
支持视觉模型如 gpt-4o、gemini-pro-vision 等">?</span>
                                </label>
                                <select id="kb-vision-model-select">
                                    <option value="">不启用</option>
                                </select>
                                <small>识别扫描版/图片 PDF 中的文字</small>
                            </div>
                        </div>
                        
                        <!-- 模型帮助弹出框 -->
                        <div class="model-help-popup" id="model-help-popup" style="display: none;">
                            <div class="model-help-header">
                                <span class="model-help-title" id="model-help-title">支持的模型</span>
                                <button class="model-help-close">&times;</button>
                            </div>
                            <div class="model-help-content" id="model-help-content"></div>
                        </div>
                        
                        <div class="form-row">
                            <label style="flex-direction: row; display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="kb-extract-images" style="width: auto;"> 
                                提取文档内图片
                                <span class="help-tip" data-tip="使用视觉模型识别PDF、Word、PPT中嵌入的图片内容。需要配置视觉模型，会增加处理时间和API调用成本。">?</span>
                            </label>
                            <small>识别文档中的图片、图表、截图等内容（需配置视觉模型）</small>
                        </div>
                        
                        <div class="form-row">
                            <label>选择文件 - 支持多选</label>
                            <input type="file" id="kb-file" multiple accept=".pdf,.docx,.doc,.pptx,.xlsx,.xls,.txt,.md,.csv,.json,.xml,.html,.htm,.png,.jpg,.jpeg,.gif,.bmp,.webp">
                            <small>支持: PDF, Word, PPT, Excel, TXT, Markdown, CSV, JSON, XML, HTML, 图片</small>
                        </div>
                        
                        <!-- 已选文件列表 -->
                        <div id="kb-file-list" class="kb-file-list" style="display: none;"></div>
                        
                        <div class="form-actions">
                            <button type="submit" id="kb-upload-btn">上传并构建知识库</button>
                        </div>
                    </form>
                    <div id="kb-upload-status" class="status-text"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MCP服务器管理弹窗 -->
<div class="modal" id="mcp-modal">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <span class="modal-title">🔌 MCP Server 管理</span>
            <button class="modal-close" data-target="mcp-modal" data-return="settings-modal">&times;</button>
        </div>
        <div class="modal-body">
            <!-- 左侧：服务器列表 -->
            <div class="mcp-list-container">
                <h3>MCP Servers</h3>
                <div id="mcp-list"></div>
                <button type="button" id="mcp-add-btn" class="add-btn">+ 新建 MCP Server</button>
            </div>
            
            <!-- 右侧：编辑表单 -->
            <div class="mcp-form-container">
                <h3 id="mcp-form-title">编辑 MCP Server</h3>
                <form id="mcp-form">
                    <input type="hidden" id="mcp-edit-name">
                    <div class="form-row compact">
                        <label>名称 <span class="required">*</span></label>
                        <input type="text" id="mcp-name" required placeholder="如 office-mcp">
                    </div>
                    <div class="form-row compact">
                        <label>类型 <span class="required">*</span></label>
                        <div class="radio-group">
                            <label><input type="radio" name="mcp-type" value="stdio" checked> 本地 (stdio)</label>
                            <label><input type="radio" name="mcp-type" value="http"> 远程 (http/sse)</label>
                        </div>
                    </div>
                    <div class="form-row compact" id="mcp-command-row">
                        <label>命令 <span class="required">*</span></label>
                        <input type="text" id="mcp-command" placeholder="如 C:/Users/xxx/uvx.exe">
                    </div>
                    <div class="form-row compact" id="mcp-args-row">
                        <label>参数</label>
                        <input type="text" id="mcp-args" placeholder="如 mcp-server-office">
                    </div>
                    <div class="form-row compact" id="mcp-url-row" style="display: none;">
                        <label>URL <span class="required">*</span></label>
                        <input type="text" id="mcp-url" placeholder="如 http://localhost:8080/sse">
                    </div>
                    <div class="form-row compact">
                        <label>环境变量</label>
                        <textarea id="mcp-env" rows="2" placeholder="KEY=VALUE 每行一个"></textarea>
                    </div>
                    <div class="form-actions-bottom compact">
                        <div class="form-actions-left">
                            <button type="button" id="mcp-delete-btn" class="btn-danger">删除</button>
                            <span id="mcp-status" class="mcp-test-status"></span>
                        </div>
                        <div class="form-actions-right">
                            <button type="button" id="mcp-test-btn" class="btn-secondary">测试</button>
                            <button type="submit" class="btn-primary">保存</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 联网搜索配置弹窗 -->
<div class="modal" id="search-config-modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="modal-title">🌐 联网搜索配置</span>
            <button class="modal-close" data-target="search-config-modal" data-return="settings-modal">&times;</button>
        </div>
        <div class="modal-body">
            <div style="width: 100%;">
                <form id="search-config-form">
                    <div class="settings-section">
                        <h4>🔍 搜索源配置</h4>
                        
                        <div class="form-row">
                            <label>默认搜索源</label>
                            <select id="search-default-source">
                                <option value="duckduckgo" selected>DuckDuckGo（免费）</option>
                                <option value="tavily">Tavily（需API Key）</option>
                            </select>
                        </div>
                        
                        <div class="form-row">
                            <label>Tavily API Key（可选）</label>
                            <input type="password" id="search-tavily-api-key" placeholder="输入Tavily API Key">
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                获取地址: <a href="https://tavily.com/" target="_blank">Tavily.com</a>（有免费额度）
                            </small>
                        </div>
                        
                        <div style="background: #fff3e0; padding: 10px; border-radius: 4px; margin-top: 10px;">
                            <small style="color: #e65100;">
                                ⚠️ DuckDuckGo 需要能够访问国际互联网，如无法访问请使用 Tavily
                            </small>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 10px; border-radius: 4px; margin-top: 8px;">
                            <small style="color: #2e7d32;">
                                💡 Tavily 提供免费额度，搜索结果质量更高，推荐使用
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit">保存配置</button>
                        <button type="button" id="search-config-reset">重置</button>
                    </div>
                </form>
                
                <div id="search-config-status" class="status-text" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- 引入Markdown处理模块 -->
<script src="markdown.js?v=131"></script>

<!-- 引入外部JavaScript -->
<script src="script.js?v=210"></script>

</body>
</html>
